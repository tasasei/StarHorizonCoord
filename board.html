<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Pragma" content="no-cache">
<meta charset="utf-8">
<script type="text/javascript" src="./plotly-latest.min.js" charset="utf-8"></script>
<script type="text/javascript" src="./horizonCoord.js" charset="utf-8"></script>
<script id="ConstellationName" type="application/json">
  [{"id":"And","name":"Andromeda","name_jp":"アンドロメダ"},{"id":"Ant","name":"Antlia","name_jp":"ポンプ"},{"id":"Aps","name":"Apus","name_jp":"ふうちょう"},{"id":"Aql","name":"Aquila","name_jp":"わし"},{"id":"Aqr","name":"Aquarius","name_jp":"みずがめ"},{"id":"Ara","name":"Ara","name_jp":"さいだん"},{"id":"Ari","name":"Aries","name_jp":"おひつじ"},{"id":"Aur","name":"Auriga","name_jp":"ぎょしゃ"},{"id":"Boo","name":"Bootes","name_jp":"うしかい"},{"id":"Cae","name":"Caelum","name_jp":"ちょうこくぐ"},{"id":"Cam","name":"Camelopardalis","name_jp":"きりん"},{"id":"Cap","name":"Capricornus","name_jp":"やぎ"},{"id":"Car","name":"Carina","name_jp":"りゅうこつ"},{"id":"Cas","name":"Cassiopeia","name_jp":"カシオペヤ"},{"id":"Cen","name":"Centaurus","name_jp":"ケンタウルス"},{"id":"Cep","name":"Cepheus","name_jp":"ケフェウス"},{"id":"Cet","name":"Cetus","name_jp":"くじら"},{"id":"Cha","name":"Chamaeleon","name_jp":"カメレオン"},{"id":"Cir","name":"Circinus","name_jp":"コンパス"},{"id":"CMa","name":"Canis Major","name_jp":"おおいぬ"},{"id":"CMi","name":"Canis Minor","name_jp":"こいぬ"},{"id":"Cnc","name":"Cancer","name_jp":"かに"},{"id":"Col","name":"Columba","name_jp":"はと"},{"id":"Com","name":"Coma Berenices","name_jp":"かみのけ"},{"id":"CrA","name":"Corona Australis","name_jp":"みなみのかんむり"},{"id":"CrB","name":"Corona Borealis","name_jp":"かんむり"},{"id":"Crt","name":"Crater","name_jp":"コップ"},{"id":"Cru","name":"Crux","name_jp":"みなみじゅうじ"},{"id":"Crv","name":"Corvus","name_jp":"からす"},{"id":"CVn","name":"Canes Venatici","name_jp":"りょうけん"},{"id":"Cyg","name":"Cygnus","name_jp":"はくちょう"},{"id":"Del","name":"Delphinus","name_jp":"いるか"},{"id":"Dor","name":"Dorado","name_jp":"かじき"},{"id":"Dra","name":"Draco","name_jp":"りゅう"},{"id":"Equ","name":"Equuleus","name_jp":"こうま"},{"id":"Eri","name":"Eridanus","name_jp":"エリダヌス"},{"id":"For","name":"Fornax","name_jp":"ろ"},{"id":"Gem","name":"Gemini","name_jp":"ふたご"},{"id":"Gru","name":"Grus","name_jp":"つる"},{"id":"Her","name":"Hercules","name_jp":"ヘルクレス"},{"id":"Hor","name":"Horologium","name_jp":"とけい"},{"id":"Hya","name":"Hydra","name_jp":"うみへび"},{"id":"Hyi","name":"Hydrus","name_jp":"みずへび"},{"id":"Ind","name":"Indus","name_jp":"インディアン"},{"id":"Lac","name":"Lacerta","name_jp":"とかげ"},{"id":"Leo","name":"Leo","name_jp":"しし"},{"id":"Lep","name":"Lepus","name_jp":"うさぎ"},{"id":"Lib","name":"Libra","name_jp":"てんびん"},{"id":"LMi","name":"Leo Minor","name_jp":"こじし"},{"id":"Lup","name":"Lupus","name_jp":"おおかみ"},{"id":"Lyn","name":"Lynx","name_jp":"やまねこ"},{"id":"Lyr","name":"Lyra","name_jp":"こと"},{"id":"Men","name":"Mensa","name_jp":"テーブルさん"},{"id":"Mic","name":"Microscopium","name_jp":"けんびきょう"},{"id":"Mon","name":"Monoceros","name_jp":"いっかくじゅう"},{"id":"Mus","name":"Musca","name_jp":"はえ"},{"id":"Nor","name":"Norma","name_jp":"じょうぎ"},{"id":"Oct","name":"Octans","name_jp":"はちぶんぎ"},{"id":"Oph","name":"Ophiuchus","name_jp":"へびつかい"},{"id":"Ori","name":"Orion","name_jp":"オリオン"},{"id":"Pav","name":"Pavo","name_jp":"くじゃく"},{"id":"Peg","name":"Pegasus","name_jp":"ペガスス"},{"id":"Per","name":"Perseus","name_jp":"ペルセウス"},{"id":"Phe","name":"Phoenix","name_jp":"ほうおう"},{"id":"Pic","name":"Pictor","name_jp":"がか"},{"id":"PsA","name":"Piscis Austrinus","name_jp":"みなみのうお"},{"id":"Psc","name":"Pisces","name_jp":"うお"},{"id":"Pup","name":"Puppis","name_jp":"とも"},{"id":"Pyx","name":"Pyxis","name_jp":"らしんばん"},{"id":"Ret","name":"Reticulum","name_jp":"レチクル"},{"id":"Scl","name":"Sculptor","name_jp":"ちょうこくしつ"},{"id":"Sco","name":"Scorpius","name_jp":"さそり"},{"id":"Sct","name":"Scutum","name_jp":"たて"},{"id":"Ser","name":"Serpens(Caput)","name_jp":"へび(頭)"},{"id":"Ser","name":"Serpens(Cauda)","name_jp":"へび(尾)"},{"id":"Sex","name":"Sextans","name_jp":"ろくぶんぎ"},{"id":"Sge","name":"Sagitta","name_jp":"や"},{"id":"Sgr","name":"Sagittarius","name_jp":"いて"},{"id":"Tau","name":"Taurus","name_jp":"おうし"},{"id":"Tel","name":"Telescopium","name_jp":"ぼうえんきょう"},{"id":"TrA","name":"Triangulum Australe","name_jp":"みなみのさんかく"},{"id":"Tri","name":"Triangulum","name_jp":"さんかく"},{"id":"Tuc","name":"Tucana","name_jp":"きょしちょう"},{"id":"UMa","name":"Ursa Major","name_jp":"おおぐま"},{"id":"UMi","name":"Ursa Minor","name_jp":"こぐま"},{"id":"Vel","name":"Vela","name_jp":"ほ"},{"id":"Vir","name":"Virgo","name_jp":"おとめ"},{"id":"Vol","name":"Volans","name_jp":"とびうお"},{"id":"Vul","name":"Vulpecula","name_jp":"こぎつね"}]
</script>

<title>board test</title>
</head>

<!-- body読み込み時に -->
<body onload="initFunc()">

<form id="param">
[マーカー]ra(deg):<input type="number" name="ra" min="0" max="360" id="ra" value="316.16639"><br>
[マーカー]dec(deg):<input type="number" name="dec" min="0" max="360" id="dec" value="38.49975"><br>
経度(現在地):<input type="number" name="lng" min="-180" max="180" id="lng" value="139.5"><br>
緯度(現在地):<input type="number" name="lat" min="-90" max="90" id="lat" value="35.788889"><br>
time zone:<input id="timezone" type="number" min="-12" max="12" value="9"><br>
year:<input type="number" name="year" min="1900" max="2100" id="year" value="2018" step="1">
month:<input type="number" name="month" min="1" max="12" id="month" value="8" step="1">
date:<input type="number" name="date" min="1" max="31" id="date" value="10" step="1">
hours:<input type="number" name="hours" min="0" max="24" id="hours" value="21" step="1">
minutes:<input type="number" name="minutes" min="0" max="60" id="minutes" value="20" step="1">
</form>

<button type=button onclick="plot()">plot</button>

<div id="myDiv"><!-- Plotly chart will be drawn inside this DIV --></div>
</body>

<script>
// ページ読み込み時用の関数
function initFunc(){
  // ra dec の初期値を空に
  document.getElementById("ra").value = "";
  document.getElementById("dec").value = "";

  // formに現在の時刻を代入
  var date = new Date();
  document.getElementById("year").value = date.getFullYear();
  document.getElementById("month").value = date.getMonth() + 1;
  document.getElementById("date").value = date.getDate();
  document.getElementById("hours").value = date.getHours();
  document.getElementById("minutes").value = date.getMinutes();

  plot();
}

function plot(){
  const ra = Number(document.forms.param.ra.value);
  const dec = Number(document.forms.param.dec.value);

  // ra と dec が両方入力されていれば、マーカーをプロットする
  var isPlotMarker = false;
  if(document.forms.param.ra.value!="" && document.forms.param.dec.value!=""){
    isPlotMarker = true;
  }

  const lng = Number(document.forms.param.lng.value);
  const lat = Number(document.forms.param.lat.value);

  const timezone = Number(document.forms.param.timezone.value);

  const yearUTC = Number(document.forms.param.year.value);
  const monthUTC = Number(document.forms.param.month.value);
  const dateUTC = Number(document.forms.param.date.value);
  const hoursUTC = Number(document.forms.param.hours.value) - timezone;
  const minutesUTC = Number(document.forms.param.minutes.value);

  // HTMLの星座名JSONをパースして読み込む
  var ConstellationName = JSON.parse(document.getElementById('ConstellationName').textContent);

  function GetHorizonCoord(ra_this, dec_this){
    return horizonCoord(ra_this, dec_this, lat, lng, yearUTC, monthUTC, dateUTC, hoursUTC, minutesUTC);
  }

  function MyConcat(ar){
    let rt_array = [];
    for(let i=0; i<ar.length; i++){
      rt_array = rt_array.concat(ar[i]);
    }
    return rt_array;
  }

  Plotly.purge("myDiv");

  Plotly.d3.csv('./star/line.csv', function(err, rows){
  function MyGetHorizonCoord(x){
    let x_num = Number(x.id);
    let start = GetHorizonCoord(Number(x.ra_start_deg),Number(x.dec_start_deg));
    start.id = x_num;
    let end = GetHorizonCoord(Number(x.ra_end_deg),Number(x.dec_end_deg));
    end.id = x_num;
    return [start, end, {h:null,A:null,id:x_num}];
  }

  let MarkerObject = GetHorizonCoord(ra,dec);
  let ah_array = MyConcat( rows.map(MyGetHorizonCoord) );

  var trace1 = {
    r: ah_array.map(x => x.h),
    theta: ah_array.map(x => x.A),
    mode: 'lines+markers',
    name: 'Stars',
    line: {color: 'peru'},
    type: 'scatterpolar',
    marker: {
      size: 4
    },

    // マウスオーバーで出す情報。
    // 元のjsonが0始まりの配列であるため、1引いている。
    text: ah_array.map(x => ConstellationName[x.id-1].name_jp),
    hoverinfo: 'text',

    connectgaps: false
  };

  var trace2 = {
    r: [MarkerObject.h,MarkerObject.h],
    theta: [MarkerObject.A,MarkerObject.A],
    mode: 'markers',
    type: 'scatterpolar',
    name: 'MARKER',
    marker: {
      color: 'red'
    }
  };

  var data;
  if(isPlotMarker){
    data = [trace1,trace2];
  }else{
    data = [trace1];
  }

  var layout = {
    title: 'インタラクティブ星座盤',
    font: {
      family: 'Arial, sans-serif;',
      size: 12,
      color: '#000'
    },
    autosize: false,
    showlegend: true,
    polar:{
      radialaxis:{
        range: [90,0]
      },
      angularaxis:{
        rotation: -90,
        dtick: 90,
        tickvals:['0','90','180','270'],
        ticktext:['S','W','N','E'],
        tickfont: {
          size: 20
        }
      }
    }
//  yaxis: {range: [2, 5]}
  };
  Plotly.plot('myDiv', data, layout);
});
}
</script>

</html>
